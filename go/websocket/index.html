<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script
      type="text/javascript"
      src="http://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"
    ></script>
    <style>
      .glyphicon.glyphicon-one-fine-full-dot {
        margin-bottom: -0.8em;
        overflow: hidden;
      }
      .glyphicon.glyphicon-one-fine-full-dot:before {
        content: "\25cf";
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Cryptocurrency Tracker</h1>
      <h5>
        Status:
        <span id="link_status"
          ><span
            style="color:yellow;"
            class="glyphicon glyphicon-one-fine-full-dot"
          ></span>
          Connecting...</span
        >
      </h5>
      <ul id="currencies"></ul>
    </div>
    <script type="text/javascript">
      $(function() {
        var ws;
        if (window.WebSocket === undefined) {
          alert("Your browser does not support WebSockets.");
          return;
        } else {
          ws = initWS();
        }
        function initWS() {
          var socket = new WebSocket("ws://localhost:3001/ws"),
            clist = $("#currencies");
          link = $("#link_status");
          socket.onopen = function() {
            console.log("Socket is open.");
            link.html(
              "<span style='color:green;' class='glyphicon glyphicon-one-fine-full-dot'></span> Connected"
            );
          };
          socket.onmessage = function(e) {
            console.log("Received data.");
            clist.empty();
            $.each(JSON.parse(e.data), function(key, value) {
              clist.append(
                "<li>" +
                  value.name +
                  " | " +
                  value.symbol +
                  " | $" +
                  value.price_usd +
                  " | " +
                  value.percent_change_24h +
                  "%</li>"
              );
            });
          };
          socket.onclose = function() {
            console.log("Socket closed.");
            link.html(
              "<span style='color:red;' class='glyphicon glyphicon-one-fine-full-dot'></span> Disconnected"
            );
            setTimeout(function() {
              initWS();
            }, 5000);
          };
          return socket;
        }
      });
    </script>
  </body>
</html>
